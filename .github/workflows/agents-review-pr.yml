name: Agents Review (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  agents-review:
    runs-on: self-hosted

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Descobrir arquivos .dart alterados na PR
        shell: bash
        run: |
          set -euo pipefail
      
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
      
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
      
          git fetch origin "$BASE_SHA" --depth=1 || true
          git fetch origin "$HEAD_SHA" --depth=1 || true
      
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '\.dart$' > changed_dart_files.txt || true
      
          echo "Arquivos .dart alterados:"
          cat changed_dart_files.txt || echo "Nenhum .dart alterado."


      - name: Chamar agente Tech Lead para cada arquivo
        run: |
          if [ ! -s changed_dart_files.txt ]; then
            echo "Nenhum arquivo .dart alterado, nada pra revisar."
            exit 0
          fi

          BASE_DIR="$(pwd)"

          while IFS= read -r file; do
            ABS_PATH="$BASE_DIR/$file"
            echo "===== Revisando: $file ====="

            JSON_PAYLOAD=$(printf '{"path": "%s", "language": "dart", "context": "Revisão automática de PR para %s"}' "$ABS_PATH" "$file")

            echo "Payload: $JSON_PAYLOAD"

            JSON_PAYLOAD=$(python3 - << PY
            import json
            import sys
            payload = {
              "path": "${ABS_PATH}",
              "language": "dart",
              "context": "Revisão automática de PR para ${file}"
            }
            print(json.dumps(payload, ensure_ascii=False))
            PY
            )

            OUT="agent_outputs/techlead_files/$(echo "$file" | tr '/\' '__').json"
            echo "$JSON_PAYLOAD" > "${OUT%.json}.payload.json"

            curl -s -X POST http://localhost:8000/techlead/review-file \
              -H "Content-Type: application/json" \
              --data-binary "$JSON_PAYLOAD" \
              | tee "$OUT"

            echo ""
          done < changed_dart_files.txt

      - name: Gerar diff completo da PR
        shell: bash
        run: |
          set -euo pipefail
      
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
      
          git fetch origin "$BASE_SHA" --depth=1 || true
          git fetch origin "$HEAD_SHA" --depth=1 || true
      
          git diff "$BASE_SHA" "$HEAD_SHA" > pr.diff
          echo "Diff salvo em pr.diff (tamanho: $(wc -l < pr.diff) linhas)"

      - name: Chamar agente Tech Lead com o diff completo (POC)
        run: |
          python3 - << 'PY'
          import json
          from pathlib import Path
      
          diff = Path("pr.diff").read_text(encoding="utf-8")
          payload = {
              "code": diff,
              "language": "diff",
              "context": "Diff completo da PR para revisão de alto nível."
          }
          Path("payload_diff.json").write_text(
              json.dumps(payload, ensure_ascii=False),
              encoding="utf-8"
          )
          print("payload_diff.json bytes:", Path("payload_diff.json").stat().st_size)
          PY
      
          python3 -m json.tool payload_diff.json > /dev/null
      
          curl -s -X POST http://localhost:8000/techlead/review-code \
            -H "Content-Type: application/json" \
            --data-binary @payload_diff.json

      - name: Chamar agente QA para plano de testes da PR
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          JSON_PAYLOAD=$(python3 - << 'PY'
          import json
          import os
          from pathlib import Path

          pr_title = os.environ.get("PR_TITLE", "") or ""
          pr_body = os.environ.get("PR_BODY", "") or ""
          diff = Path("pr.diff").read_text(encoding="utf-8")

          payload = {
              "pr_title": pr_title,
              "pr_body": pr_body,
              "diff": diff,
              "context": "Gerar plano de testes (manuais e automatizados) para esta PR."
          }

          print(json.dumps(payload))
          PY
          )

          curl -s -X POST http://localhost:8000/qa/pr-tests \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

      - name: Upload outputs (TechLead/QA)
        uses: actions/upload-artifact@v4
        with:
          name: agent_outputs
          path: agent_outputs/



