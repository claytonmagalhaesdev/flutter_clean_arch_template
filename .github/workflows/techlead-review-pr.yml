name: TechLead Review (PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  agents-review:
    runs-on: self-hosted

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Descobrir arquivos .dart alterados na PR
        run: |
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"

          # Busca a branch base (ex: main) para comparar
          git fetch origin ${{ github.base_ref }} --depth=1

          # Lista os arquivos alterados entre base e HEAD
          git diff --name-only FETCH_HEAD...HEAD | grep '\.dart$' > changed_dart_files.txt || true

          echo "Arquivos .dart alterados:"
          cat changed_dart_files.txt || echo "Nenhum .dart alterado."

      - name: Chamar agente Tech Lead para cada arquivo
        run: |
          if [ ! -s changed_dart_files.txt ]; then
            echo "Nenhum arquivo .dart alterado, nada pra revisar."
            exit 0
          fi

          BASE_DIR="$(pwd)"

          while IFS= read -r file; do
            ABS_PATH="$BASE_DIR/$file"
            echo "===== Revisando: $file ====="

            JSON_PAYLOAD=$(printf '{"path": "%s", "language": "dart", "context": "Revisão automática de PR para %s"}' "$ABS_PATH" "$file")

            echo "Payload: $JSON_PAYLOAD"

            # Chama seu serviço local
            curl -s -X POST http://localhost:8000/techlead/review-file \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD" \
              || echo "Falha ao revisar $file"

            echo ""
          done < changed_dart_files.txt

      - name: Gerar diff completo da PR
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff FETCH_HEAD...HEAD > pr.diff
          echo "Diff salvo em pr.diff (tamanho: $(wc -l < pr.diff) linhas)"

      - name: Chamar agente Tech Lead com o diff completo (POC)
        run: |
          # Monta o JSON com Python pra evitar problema com quebras de linha e aspas
          JSON_PAYLOAD=$(python - << 'PY'
          import json
          from pathlib import Path

          diff = Path("pr.diff").read_text(encoding="utf-8")

          payload = {
              "code": diff,
              "language": "diff",
              "context": "Diff completo da PR para revisão de alto nível."
          }

          print(json.dumps(payload))
          PY
          )

          echo "Payload montado, chamando /techlead/review-code ..."
          echo "$JSON_PAYLOAD" | head -c 300
          echo ""

          curl -s -X POST http://localhost:8000/techlead/review-code \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            || echo "Falha ao revisar diff da PR"

      - name: Chamar agente QA para plano de testes da PR
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          JSON_PAYLOAD=$(python - << 'PY'
          import json
          import os
          from pathlib import Path

          pr_title = os.environ.get("PR_TITLE", "") or ""
          pr_body = os.environ.get("PR_BODY", "") or ""
          diff = Path("pr.diff").read_text(encoding="utf-8")

          payload = {
              "pr_title": pr_title,
              "pr_body": pr_body,
              "diff": diff,
              "context": "Gerar plano de testes (manuais e automatizados) para esta PR."
          }

          print(json.dumps(payload))
          PY
          )

          curl -s -X POST http://localhost:8000/qa/pr-tests \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"


